# climate:
#   platform: nest
  
script:
  heat_up:
    alias: '[Climate] Increase temperature with 1 degree'
    sequence:
    - service: climate.set_temperature
      data_template:
        entity_id: climate.living_room
        temperature: "{{ state_attr('climate.living_room' , 'current_temperature') | float | round(1) + 1 }}"

  cool_down:
    alias: '[Climate] Decrease temperature with 1 degree'
    sequence:
    - service: climate.set_temperature
      data_template:
        entity_id: climate.living_room
        temperature: "{{ state_attr('climate.living_room' , 'current_temperature') | float | round(1) - 1 }}"

  tell_current_living_room_temperature:
    alias: '[Climate] Tell current living room temperature'
    sequence:
      - service: notify.alexa_media
        data_template:
          data:
            type: tts
          target: >-
            {# Use the name of each Echo to determine which room the command likely came from. #}
            {%- set room = states("sensor.last_alexa")|replace('media_player.','') -%}

            {%- if room == "living_room" -%}
              media_player.living_room
            {%- elif room == "living_room_fire_tv_stick" -%}
              media_player.living_room_fire_tv_stick
            {%- elif room == "master_bedroom" -%}
              media_player.master_bedroom
            {%- elif room == "master_bedroom_fire_tv_stick" -%}
              media_player.master_bedroom_fire_tv_stick
            {%- elif room == "lucas_room" -%}
              media_player.lucas_room
            {%- elif room == "timo_s_room" -%}
              media_player.timo_s_room
            {%- elif room == "emilie_s_room" -%}
              media_player.emilie_s_room
            {%- endif -%}
          message: "The current living room temperature is {{ state_attr('climate.living_room' , 'current_temperature') }} degrees celsius"

automation:
  - id: 811e963d-f24e-47bd-b0fb-b519bb0e6dbb
    alias: '[Climate] Away Mode'
    initial_state: 'true'
    trigger:
      - platform: state
        entity_id: group.household
        from: home
        to: not_home
    mode: single
    condition:
      - condition: state
        entity_id: input_boolean.guest_mode
        state: 'off'
    action:
      - service: climate.set_preset_mode
        entity_id:
          - climate.living_room
        data: {"preset_mode": "away"}

  - id: 039d5bb6-5335-4c0c-9c37-c0d286bcecae
    alias: '[Climate] Home Mode'
    initial_state: 'true'
    trigger:
      - platform: state
        entity_id: group.household
        from: not_home
        to: home
    mode: single
    action:
      - service: climate.set_preset_mode
        entity_id:
          - climate.living_room
        data: {"preset_mode": "home"}

  - id: 763d3d6d-c8f2-473b-86ed-ad6d41ff0083
    alias: '[Climate] Disable thermostat away'
    initial_state: 'true'
    trigger:
      - platform: time_pattern
        minutes: /5
        seconds: 0
    mode: single
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: alarm_control_panel.konnected_alarm
            state: armed_away
      - condition: state
        entity_id: binary_sensor.retsinagaard_away
        state:  'on'
    action:
      - service: climate.set_preset_mode
        entity_id:
          - climate.living_room
        data: {"preset_mode": "home"}

  - id: e7d7fec6-be05-4aa2-bdd5-e8b2a4c585e7
    alias: '[Climate] Enable thermostat away'
    initial_state: 'true'
    trigger:
      - platform: time_pattern
        minutes: /5
        seconds: 0
    mode: single
    condition:
      - condition: state
        entity_id: alarm_control_panel.konnected_alarm
        state:  armed_away
      - condition: state
        entity_id:
          - binary_sensor.retsinagaard_away
          - input_boolean.guest_mode
        state:  'off'
    action:
      - service: climate.set_preset_mode
        entity_id:
          - climate.living_room
        data: {"preset_mode": "away"}

  - id: 82e04eda-e291-4af7-be6f-f6ec33719802
    alias: '[Climate] Set thermostat ETA'
    initial_state: 'true'
    trigger:
      - platform: template
        value_template: "{%- if is_state_attr('proximity.home', 'dir_of_travel', 'towards')\
          \ -%}\n  true\n{%- endif -%}\n"
    mode: single
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: group.household
          state: not_home
        - condition: state
          entity_id: binary_sensor.retsinagaard_away
          state: 'on'
    action:
      - service: nest.set_eta
        data_template:
          eta: >
            {% if is_state_attr('proximity.home', 'nearest', 'Dennis') %}
              {{ ((( states.sensor.dennis_to_home.state | int) * 60) - 3600) | timestamp_custom('%H:%M:%S') }}
            {% elif is_state_attr('proximity.home', 'nearest', 'Dennis, Stephanie') %}
              {{ ((( states.sensor.dennis_to_home.state | int) * 60) - 3600) | timestamp_custom('%H:%M:%S') }}
            {% elif is_state_attr('proximity.home', 'nearest', 'Stephanie') %}
              {{ ((( states.sensor.stephanie_to_home.state | int) * 60) - 3600) | timestamp_custom('%H:%M:%S') }}
            {% endif %}
          eta_window: 00:01
          trip_id: ETA set by HAS
          structure:
            - Retsinagaard

  - id: d2851e95-9ef6-49bf-973d-9ed51545414c
    alias: '[Climate] Cancel thermostat ETA'
    initial_state: 'true'
    trigger:
      - platform: state
        entity_id: group.household
        from: not_home
        to: home
      - platform: template
        value_template: "{% if is_state_attr('proximity.home', 'dir_of_travel', 'towards') %}false{% endif %}"
        for: '00:10:00'
    mode: single
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.retsinagaard_eta
            state: "1970-01-01 00:00:00+00:00"
    action:
      - service: nest.cancel_eta
        data:
          trip_id: ETA set by HAS
          structure:
            - Retsinagaard
      - service: climate.set_preset_mode
        entity_id:
          - climate.living_room
        data: {"preset_mode": "home"}
