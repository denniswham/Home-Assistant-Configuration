homeassistant:
  customize:
    input_boolean.konnectedupdate:
      friendly_name: Auto Alarm
      icon: mdi:security
    switch.siren:
      friendly_name: Alarm siren
      icon: mdi:alarm-bell


konnected:
  access_token: !secret konnected_access_token
#  api_host: !secret konnected_api_host
  devices:
    - id: !secret konnected_device_id
      binary_sensors:
        - zone: 1
          type: motion
          name: 'Entryway'
        - zone: 2
          type: motion
          name: 'Kitchen'
        - zone: 3
          type: motion
          name: 'Living Room'
        - zone: 4
          type: motion
          name: 'Office'
        - zone: 5
          type: motion
          name: 'Garage'
      switches:
        - zone: out
          name: 'Siren'
      blink: false

alarm_control_panel:
  - platform: manual
    name: Konnected Alarm
    pending_time: 30
    delay_time: 20
    trigger_time: 4
    disarmed:
      trigger_time: 0
    armed_home:
      pending_time: 300
      delay_time: 20

automation:
  - alias: '[Alarm] Arm Konnected'
    initial_state: 'true'
    condition:
    - condition: state
      entity_id: input_boolean.konnectedupdate
      state: 'on'
    - condition: template
      value_template: "{%- if states.automation.alarm_disarm_konnected_from_away.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.alarm_disarm_konnected_from_away.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
    - condition: template
      value_template: '{{ states(''input_select.konnectedstatus'') != ''armed_away'' 
        }}'
    - condition: template
      value_template: '{{ states(''alarm_control_panel.konnected_alarm'') == ''disarmed''
        }}'
    trigger:
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
      for: 00:05:00
    action:
    - service: input_select.select_option
      data:
        entity_id: input_select.konnectedstatus
        option: armed_away
    - service: alarm_control_panel.alarm_arm_away
      entity_id:
        - alarm_control_panel.konnected_alarm
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
        - group.alexa
        message: I'll start guarding now

  - alias: '[Alarm] Deactivate siren'
    initial_state: 'true'
    trigger:
    - platform: state
      entity_id: alarm_control_panel.Konnected_Alarm
      to: triggered
      for: 00:20:00
    - platform: state
      entity_id: alarm_control_panel.Konnected_Alarm
      to: disarmed
    action:
    - service: switch.turn_off
      entity_id: switch.siren
    - service: switch.turn_off
      entity_id: switch.backyard_siren

  - alias: '[Alarm] Disarm Konnected at night'
    initial_state: 'true'
    condition:
    - condition: state
      entity_id: input_boolean.konnectedupdate
      state: 'on'
    trigger:
    - platform: state
      entity_id:
      - person.dennis
      - person.stephanie
      - person.lucas
      - person.timo
      to: home
    action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

  - alias: '[Alarm] Disarm Konnected from Away'
    initial_state: 'true'
    condition:
    - condition: state
      entity_id: input_select.konnectedstatus
      state: armed_away
    - condition: state
      entity_id: input_boolean.konnectedupdate
      state: 'on'
    - condition: template
      value_template: "{%- if states.automation.alarm_arm_konnected.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.alarm_arm_konnected.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
    trigger:
    - platform: state
      entity_id: group.household
      from: not_home
      to: home
    action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

  - alias: '[Alarm] Disarm Konnected in the morning'
    initial_state: 'true'
    condition:
      condition: and
      conditions:
      - condition: state
        entity_id: group.household
        state: home
      - condition: state
        entity_id: input_boolean.konnectedupdate
        state: 'on'
    trigger:
    - platform: time
      at: 06:00:00
    action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

  - alias: '[Alarm] Konnected Standby'
    initial_state: 'true'
    condition:
      condition: and
      conditions:
      - condition: state
        entity_id: group.household
        state: home
      - condition: time
        after: 06:15:00
        before: '21:00:00'
      - condition: state
        entity_id: input_boolean.konnectedupdate
        state: 'on'
      - condition: template
        value_template: "{%- if states.input_select.konnectedstatus.last_changed -%}\n\
          \  {{ (as_timestamp(now()) - as_timestamp(states.input_select.konnectedstatus.last_changed))\
          \ > 300 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
      - condition: or
        conditions:
        - condition: state
          entity_id: input_select.konnectedstatus
          state: armed_home
        - condition: state
          entity_id: input_select.konnectedstatus
          state: armed_away
    trigger:
    - platform: time_pattern
      minutes: /10
      seconds: 0
    action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

  - alias: '[Alarm] Konnected Log Motion'
    initial_state: 'true'
    trigger:
    - platform: state
      entity_id: binary_sensor.entryway
      to: 'on'
    - platform: state
      entity_id: binary_sensor.kitchen
      to: 'on'
    - platform: state
      entity_id: binary_sensor.living_room
      to: 'on'
    - platform: state
      entity_id: binary_sensor.office
      to: 'on'
    - platform: state
      entity_id: binary_sensor.garage
      to: 'on'
    - platform: state
      entity_id: binary_sensor.ring_backyard_motion
      to: 'on'
    condition:
      condition: or
      conditions:
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_away
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_home
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: pending
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: triggered
    action:
    - service: logbook.log
      data_template:
        name: "Motion detected: "
        message: >-
          {{ trigger.entity_id }}

  - alias: '[Alarm] Trigger Alarm'
    initial_state: 'true'
    trigger:
    - platform: state
      entity_id: alarm_control_panel.Konnected_Alarm
      to: triggered
    action:
    - service: switch.turn_on
      entity_id: switch.siren
    - service: switch.turn_on
      entity_id: switch.backyard_siren
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
          - group.alexa
        message: Your alarm was activated
    - service: notify.html5
      data:
        title: Konnected
        message: Your alarm was activated
        data:
          actions:
            - action: open
              icon: "/local/icons/konnected.png"
              title: Open Home Assistant
          tag: konnected-alarm-notification
          ttl: 86400
          priority: high      
    - service: notify.notify
      data:
        message: "Your alarm was activated"
        data:
          push:
            badge: 0
            category: alarm_control_panel.Konnected_Alarm

  - alias: '[Alarm] Pending alarm'
    initial_state: 'true'
    trigger:
    - platform: state
      entity_id: binary_sensor.entryway
      to: 'on'
    - platform: state
      entity_id: binary_sensor.kitchen
      to: 'on'
    - platform: state
      entity_id: binary_sensor.living_room
      to: 'on'
    - platform: state
      entity_id: binary_sensor.office
      to: 'on'
    - platform: state
      entity_id: binary_sensor.garage
      to: 'on'
    condition:
      condition: or
      conditions:
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_away
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_home
    action:
    - service: alarm_control_panel.alarm_trigger
      entity_id: alarm_control_panel.Konnected_Alarm
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
          - group.alexa
        message: Motion detected, the alarm will activate shortly. Motion detected, the alarm will activate shortly.

script:
  konnectedstandby:
    alias: Alarm - Konnected Standby
    sequence:
      - service: input_select.select_option
        data:
          entity_id: input_select.konnectedstatus
          option: disarmed
      - service: alarm_control_panel.alarm_disarm
        entity_id:
          - alarm_control_panel.konnected_alarm

sensor:
  - platform: template
    sensors:
      sirens:
        friendly_name: 'Siren sound'
        entity_id: switch.siren, switch.backyard_siren
        value_template: >-
          {% if is_state('switch.siren', 'on') or is_state("switch.siren", "on") %}
            signaling
          {% else %}
            silent
          {% endif %}

  # - platform: template           #doublecheck
  #   switches:
  #     security_armed:
  #       friendly_name: Home Security Arm
  #       value_template: "{{states('alarm_control_panel.konnected_alarm') != 'disarmed'}}"
  #       turn_on:
  #         - service: alarm_control_panel.alarm_arm_away
  #           entity_id:
  #             - alarm_control_panel.konnected_alarm
  #       turn_off:
  #         - service: alarm_control_panel.alarm_disarm
  #           entity_id:
  #             - alarm_control_panel.konnected_alarm

input_boolean:
  konnectedupdate:
    name: Alarm Updates
    initial: on
    icon: mdi:security_armed

input_select:
  konnectedstatus:
    name: Alarm status
    options:
      - disarmed
      - armed_home
      - armed_away
    initial: disarmed
    icon: mdi:security