sensor:
  # Sensor to track available updates for supervisor & addons
  - platform: command_line
    name: Supervisor updates
    command: 'curl http://supervisor/supervisor/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version,"addons":[.data.addons[] | select(.version != .installed)]}'''
    value_template: "{{ value_json.addons | length }}"
    json_attributes:
    - newest_version
    - current_version
    - addons

  # Sensors to track updates to other core components (audio, dns, CLI and multicast)
  - platform: command_line
    name: Updater Audio
    command: 'curl http://supervisor/audio/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version}'''
    value_template: "{% if value_json.newest_version != value_json.current_version %}on{% else %}off{% endif %}"
    json_attributes:
    - newest_version
    - current_version
  - platform: command_line
    name: Updater DNS
    command: 'curl http://supervisor/dns/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version}'''
    value_template: "{% if value_json.newest_version != value_json.current_version %}on{% else %}off{% endif %}"
    json_attributes:
    - newest_version
    - current_version
  - platform: command_line
    name: Updater CLI
    command: 'curl http://supervisor/cli/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version}'''
    value_template: "{% if value_json.newest_version != value_json.current_version %}on{% else %}off{% endif %}"
    json_attributes:
    - newest_version
    - current_version
  - platform: command_line
    name: Updater Multicast
    command: 'curl http://supervisor/multicast/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version}'''
    value_template: "{% if value_json.newest_version != value_json.current_version %}on{% else %}off{% endif %}"
    json_attributes:
    - newest_version
    - current_version
  # Alternate updater sensor for core since binary_sensor.updater is very slow to recognize updates
  - platform: command_line
    name: Updater Core
    command: 'curl http://supervisor/core/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version}'''
    value_template: "{% if value_json.newest_version != value_json.current_version %}on{% else %}off{% endif %}"
    json_attributes:
    - newest_version
    - current_version
  - platform: command_line
    name: Updater OS
    command: 'curl http://supervisor/os/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version}'''
    value_template: "{% if value_json.newest_version != value_json.current_version %}on{% else %}off{% endif %}"
    json_attributes:
    - newest_version
    - current_version
  

binary_sensor:
  - platform: template
    sensors:
      # True if there's an update available for supervisor
      updater_supervisor:
        friendly_name: 'Updater - Supervisor'
        device_class: problem
        entity_id:
        - sensor.supervisor_updates
        value_template: "{{ state_attr('sensor.supervisor_updates', 'current_version') != state_attr('sensor.supervisor_updates', 'newest_version') }}"
        availability_template: "{{ (states('sensor.supervisor_updates') | int(-1)) > -1 }}"

      # True if there's updates available for any HACS components
      updater_hacs:
        friendly_name: 'Updater - HACS'
        device_class: problem
        entity_id:
        - sensor.hacs
        value_template: "{{ states('sensor.hacs') | int > 0 }}"

      # True if there's updates available for any addons
      updater_addons:
        friendly_name: 'Updater - Addons'
        device_class: problem
        entity_id:
        - sensor.supervisor_updates
        value_template: "{{ states('sensor.supervisor_updates') | int > 0 }}"

alert:
  # Update is available - un-acknowledgeble, auto-dismiss, me only
  # Wait 5 minutes before first to give core config check time to run
  ha_update_available:
    name: HA has an update
    entity_id: sensor.updater_core
    state: 'on'
    can_acknowledge: false
    repeat: 
    - 5
    - 360
    skip_first: true
    title: 'Update for HA available'
    message: "New version is {{ state_attr('sensor.updater_core', 'newest_version') }}. Currently on {{ state_attr('sensor.updater_core', 'current_version') }}"
    notifiers:
    - 
    data:
      tag: 'ha-update-available'
      url: '/hassio/addon/core_check_config'

  # Supervisor update is available - un-acknowledgeable, auto-dismiss, me only
  supervisor_update_available:
    name: Supervisor has an update
    entity_id: binary_sensor.updater_supervisor
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for HA Supervisor available'
    message: "New version is {{ state_attr('sensor.supervisor_updates', 'newest_version') }}. Currently on {{ state_attr('sensor.supervisor_updates', 'current_version') }}"
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'supervisor-update-available'
      url: '/hassio/dashboard'

  # OS update is available - un-acknowledgeable, auto-dismiss, me only
  os_update_available:
    name: OS has an update
    entity_id: sensor.updater_os
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for OS available'
    message: "New version is {{ state_attr('sensor.updater_os', 'newest_version') }}. Currently on {{ state_attr('sensor.updater_os', 'current_version') }}"
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'os-update-available'
      url: '/hassio/dashboard'


  # Audio update is available - un-acknowledgeable, auto-dismiss, me only
  audio_update_available:
    name: Audio has an update
    entity_id: sensor.updater_audio
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for HA Audio available'
    message: "New version is {{ state_attr('sensor.updater_audio', 'newest_version') }}. Currently on {{ state_attr('sensor.updater_audio', 'current_version') }}"
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'audio-update-available'
      url: '/hassio/dashboard'

  # DNS update is available - un-acknowledgeable, auto-dismiss, me only
  dns_update_available:
    name: DNS has an update
    entity_id: sensor.updater_dns
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for HA DNS available'
    message: "New version is {{ state_attr('sensor.updater_dns', 'newest_version') }}. Currently on {{ state_attr('sensor.updater_dns', 'current_version') }}"
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'dns-update-available'
      url: '/hassio/dashboard'

  # CLI update is available - un-acknowledgeable, auto-dismiss, me only
  cli_update_available:
    name: CLI has an update
    entity_id: sensor.updater_cli
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for HA CLI available'
    message: "New version is {{ state_attr('sensor.updater_cli', 'newest_version') }}. Currently on {{ state_attr('sensor.updater_cli', 'current_version') }}"
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'cli-update-available'
      url: '/hassio/dashboard'

  # Multicast update is available - un-acknowledgeable, auto-dismiss, me only
  multicast_update_available:
    name: Multicast has an update
    entity_id: sensor.updater_multicast
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for HA Multicast available'
    message: "New version is {{ state_attr('sensor.updater_multicast', 'newest_version') }}. Currently on {{ state_attr('sensor.updater_multicast', 'current_version') }}"
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'multicast-update-available'
      url: '/hassio/dashboard'

  # HACS repos have updates available - unacknowledgeable, auto-dismiss, me only
  hacs_update_available:
    name: HACS repos have updates
    entity_id: binary_sensor.updater_hacs
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: "Updates available in {{ states('sensor.hacs') }} HACS repo{% if states('sensor.hacs') | int > 1 %}s{% endif %}"
    message: ""
    notifiers:
      - mobile_app_sm_g960f
    data:
      tag: 'hacs-update-available'
      url: '/hacs/installed'

  # Addons have updates available - unacknowledgeable, auto-dismiss, me only
  addon_update_available:
    name: Addons have updates
    entity_id: binary_sensor.updater_addons
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: "Updates available for {{ states('sensor.supervisor_updates') }} HA addon{% if states('sensor.supervisor_updates') | int > 1 %}s{% endif %}"
    message: ""
    notifiers:
    - mobile_app_sm_g960f
    data:
      tag: 'addon-update-available'
      url: '/hassio/dashboard'

automation:
  - id: e14918df-1e9d-41b8-9960-c8c32cd9c21e
    alias: '[System] Check config with update'
    description: Starts the check config addon when an update becomes available
    trigger:
    - entity_id: sensor.updater_core
      platform: state
      to: 'on'
    condition: []
    action:
    - data:
        addon: core_check_config
      service: hassio.addon_start

  - id: 9853b928-ccfd-4615-a93b-5458c3ca5887
    alias: '[ HA ] Update HA at night'
    initial_state: 'off'
    trigger:
      - platform: time
        at: 03:30:00
    action:
      - service: hassio.addon_stdin
        data:
          addon: a0d7b954_ssh
          input: "ha core update"

  - id: 216fef01-3136-40f1-801d-fdf4dfc4edcb
    alias: '[ HA ] Update supervisor at night'
    initial_state: 'off'
    trigger:
      - platform: time
        at: 04:00:00
    action:
      - service: hassio.addon_stdin
        data:
          addon: a0d7b954_ssh
          input: "ha supervisor update"

  - id: 318de4ad-cf10-40a2-aff9-048c899f3f94
    alias: '[ HA ] Update OS at night'
    initial_state: 'off'
    trigger:
      - platform: time
        at: 04:30:00
    action:
      - service: hassio.addon_stdin
        data:
          addon: a0d7b954_ssh
          input: "ha os update"
