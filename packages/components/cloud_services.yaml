homeassistant:
  customize:
    switch.backyard_siren:
      friendly_name: Backyard Siren
      icon: mdi:alarm-bell
    switch.living_room_do_not_disturb_switch:
      friendly_name: Living Room Echo Dot
    switch.living_room_fire_tv_stick_do_not_disturb_switch:
      friendly_name: Living Room FireTV Stick
    switch.master_bedroom_do_not_disturb_switch:
      friendly_name: Master Bedroom Echo Dot
    switch.master_bedroom_fire_tv_stick_do_not_disturb_switch:
      friendly_name: Master Bedroom FireTV Stick
    switch.lucas_room_do_not_disturb_switch:
      friendly_name: Lucas' Room Echo Dot
    switch.timo_s_room_do_not_disturb_switch:
      friendly_name: Timo's Room Echo Dot
    switch.emilie_s_room_do_not_disturb_switch:
      friendly_name: Emilie's Room Echo Dot
    alarm_control_panel.alexa_guard_7514f:
      friendly_name: Alexa Guard
      alarm_control_panel.woerden_mode:
      friendly_name: Ring Mode
  

group:
  alexa:
    - media_player.dennis_s_alexa_app_on_surface_pro_4
    - media_player.dennis_s_alexa_apps
    - media_player.dennis_s_alexa_on_cortana
    - media_player.emilie_s_room
    - media_player.living_room
    - media_player.lucas_room
    - media_player.master_bedroom
    - media_player.this_device
    - media_player.timo_s_room
    - media_player.living_room_fire_tv_stick
    - media_player.master_bedroom_fire_tv_stick

sensor:
  - platform: template
    sensors:
        last_alexa:
          entity_id:
          - media_player.living_room
          - media_player.master_bedroom
          - media_player.lucas_room
          - media_player.timo_s_room
          - media_player.emilie_s_room
          - media_player.living_room_fire_tv_stick
          - media_player.master_bedroom_fire_tv_stick
          value_template: >
            {{ states.media_player | selectattr('attributes.last_called','eq',True) | map(attribute='entity_id') | first }}

binary_sensor:
  - platform: template
    sensors:
      alexa_guard_unavailable:
        friendly_name: "Alexa Guard" 
        device_class: problem
        entity_id:
        - alarm_control_panel.alexa_guard_7514f
        value_template: "{{ is_state('alarm_control_panel.alexa_guard_7514f', 'unavailable') }}"

alert:
  alexa_guard_unavailable:
    name: Alexa Guard unavailable
    entity_id: binary_sensor.alexa_guard_unavailable
    state: 'on'
    repeat: 30
    can_acknowledge: false
    skip_first: false
    message: "Check refresh token for Alexa Media Player Custom Component"
    done_message: "Alexa Media Player Custom Component has restored itself" 
    notifiers:
      - mobile_app_sm_g986b
    data:
      tag: 'alexa-guard-unavailable'

automation:
  - id: acd769e4-3ab3-4fa1-91f8-6d297527439f
    alias: '[Alexa] Arm Away Alexa Guard based on Konnected Alarm'
    trigger:
      - platform: state
        entity_id: alarm_control_panel.konnected_alarm
        to: armed_away
    mode: single
    action:
      - service: alarm_control_panel.alarm_arm_away
        entity_id:
          - alarm_control_panel.alexa_guard_7514f
      
  - id: b6200c2d-ffa0-42f6-bcd8-5e88ec83ad2c
    alias: '[Alexa] Disarm Alexa Guard based on Konnected Alarm'
    trigger:
      - platform: state
        entity_id: alarm_control_panel.konnected_alarm
        to: disarmed
    mode: single
    condition:
      - condition: state
        entity_id: alarm_control_panel.alexa_guard_7514f
        state: armed_away
    action:
      - service: alarm_control_panel.alarm_disarm
        entity_id:
          - alarm_control_panel.alexa_guard_7514f