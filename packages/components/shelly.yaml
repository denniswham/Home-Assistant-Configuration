group:
  shelly_firmware:
    name: Shelly Firmware
    entities:
      - cover.lucas_room_roller_shutter_firmware_update
      - cover.backyard_awning_firmware_update
      - cover.master_bedroom_roller_shutter_firmware_update
      - light.shelly_dimmer_d0f0af_light_0_firmware_update
      - light.shelly_dimmer_d17712_light_0_firmware_update
      - light.shelly_dimmer_d17b0e_light_0_firmware_update
      - light.shelly_dimmer_d47c54_light_0_firmware_update
      - light.shelly_dimmer_d48409_light_0_firmware_update
      - light.shelly_plug_s_8016cb_relay_0_firmware_update
      - light.attic_light_firmware_update
      - light.backyard_wall_lights_firmware_update
      - light.hallway_light_firmware_update
      - switch.shelly_plug_s_8013cd_relay_0_firmware_update
      - switch.shelly_plug_s_f8d1ea_relay_0_firmware_update
      - switch.shelly_plug_s_f8d1fa_relay_0_firmware_update

binary_sensor:
  - platform: template
    sensors:
      # True if there's an update available for supervisor
      updater_shelly:
        friendly_name: 'Updater - Shelly'
        device_class: problem
        entity_id:
          - group.shelly_firmware
        value_template: "{{ states('group.shelly_firmware') }}"
        availability_template: "{{ states('group.shelly_firmware') != 'unknown' }}"

alert:
  # Shelly update is available - un-acknowledgeable, auto-dismiss, me only
  shelly_update_available:
    name: Shelly has an update
    entity_id: group.shelly_firmware
    state: 'on'
    can_acknowledge: false
    repeat: 360
    title: 'Update for Shelly available'
    message: "Updates available for Shelly"
    notifiers:
    - 'dennis'
    data:
      tag: 'shelly_update_available'
      url: 'https://my.shelly.cloud/#dashboard'

automation:
- id: 263db818-00d1-4691-8847-b0bd2d491fbb
  alias: 'Shellies Announce'
  trigger:
    - platform: homeassistant
      event: start
  action:
    service: mqtt.publish
    data:
      topic: shellies/command
      payload: announce

- id: 9d090e06-286a-437d-9e76-810f938782f0
  alias: 'Shellies Discovery'
  trigger:
    - platform: mqtt
      topic: shellies/announce
  action:
    service: python_script.shellies_discovery
    data_template:
      id: '{{ trigger.payload_json.id }}'
      mac: '{{ trigger.payload_json.mac }}'
      fw_ver: '{{ trigger.payload_json.fw_ver }}'
      discovery_prefix: 'homeassistant'
      qos: 0
      shellyplug-s-8013CD:
        relay-0: "switch"
        relay-0-name: "Living Room Amplifier"
        force_update_sensors: true
      shellyplug-s-8016CB:
        relay-0: "light"
        relay-0-name: "Backyard Garden Lights"
        force_update_sensors: true
      shellyplug-s-F8D1EA:
        relay-0: "switch"
        relay-0-name: "Attic Washing Machine"
        force_update_sensors: true
      shellyplug-s-F8D1FA:
        relay-0: "switch"
        relay-0-name: "Attic Tumble Dryer"
        force_update_sensors: true
      shellyswitch25-c4c964:
        mode: "roller"
        roller-0-name: "Master Bedroom Roller Shutter"
        force_update_sensors: true
      shellyswitch25-c4c695:
        mode: "roller"
        roller-0-name: "Lucas Room Roller Shutter"
        force_update_sensors: true
      shellyswitch25-c4c708:
        mode: "roller"
        roller-0-name: "Backyard Awning"
        force_update_sensors: true
      shellydimmer-d17b0e:
        light-0-name: "Living Room Dining Table Light"
        force_update_sensors: true
      shellydimmer-D48409:
        light-0-name: "Living Room Wall Lights"
        force_update_sensors: true
      shellydimmer-D17712:
        light-0-name: "Living Room Spot Lights"
        force_update_sensors: true
      shellydimmer-D0F0AF:
        light-0-name: "Living Room Led Strips"
        force_update_sensors: true
      shellydimmer-d47c54:
        light-0-name: "Office Spots"
        force_update_sensors: true
      shelly1pm-F2F9BF:
        relay-0: "light"
        relay-0-name: "Hallway Light"
        push_off_delay: false
        force_update_sensors: true
      shelly1pm-B98825:
        relay-0: "light"
        relay-0-name: "Attic Light"
        push_off_delay: false
        force_update_sensors: true
      shelly1pm-F27A0A:
        relay-0: "light"
        relay-0-name: "Backyard Wall Lights"
        push_off_delay: false
        force_update_sensors: true

