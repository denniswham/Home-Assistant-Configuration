- id: 3c28420d-2670-4215-bd93-7b2ca445fbb4
  alias: '[Alarm] Arm Konnected'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: template
      value_template: "{%- if states.automation.alarm_disarm_konnected_from_away.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.alarm_disarm_konnected_from_away.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
    - condition: template
      value_template: '{{ states(''input_select.konnectedstatus'') != ''armed_away'' 
        }}'
    - condition: template
      value_template: '{{ states(''alarm_control_panel.konnected_alarm'') == ''disarmed''
        }}'
  trigger:
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
      for: 00:05:00
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.konnectedstatus
        option: armed_away
    - service: alarm_control_panel.alarm_arm_away
      entity_id:
        - alarm_control_panel.konnected_alarm
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
        - group.alexa
        message: I'll start guarding now

- id: f586bfa3-cec3-4881-8cbb-bb2ceb9aea62
  alias: '[Alarm] Deactivate siren'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.Konnected_Alarm
      to: triggered
      for: 00:20:00
    - platform: state
      entity_id: alarm_control_panel.Konnected_Alarm
      to: disarmed
  action:
    - service: switch.turn_off
      entity_id: switch.siren
    - service: switch.turn_off
      entity_id: switch.backyard_siren

- id: 2d57cc0c-7317-486f-a2f2-b755c59ac660
  alias: '[Alarm] Disarm Konnected at night'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
  trigger:
    - platform: state
      entity_id:
      - person.dennis
      - person.stephanie
      - person.lucas
      - person.timo
      to: home
  action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

- id: d4ce8893-a219-499b-bd45-18a2bc5bc6c2
  alias: '[Alarm] Disarm Konnected from Away'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_select.konnectedstatus
      state: armed_away
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: template
      value_template: "{%- if states.automation.alarm_arm_konnected.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.alarm_arm_konnected.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
  trigger:
    - platform: state
      entity_id: group.household
      from: not_home
      to: home
  action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

- id: b937f244-4e93-4ab7-9310-a1c77a7c05d4
  alias: '[Alarm] Disarm Konnected in the morning'
  initial_state: 'true'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.household
        state: home
      - condition: state
        entity_id: input_boolean.guest_mode
        state: 'off'
  trigger:
    - platform: time
      at: 06:00:00
  action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

- id: 8efa2a7d-23c9-4bb3-b163-4e1bf820976d
  alias: '[Alarm] Konnected Standby'
  initial_state: 'true'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.household
        state: home
      - condition: time
        after: 06:15:00
        before: '21:00:00'
      - condition: state
        entity_id: input_boolean.guest_mode
        state: 'off'
      - condition: template
        value_template: "{%- if states.input_select.konnectedstatus.last_changed -%}\n\
          \  {{ (as_timestamp(now()) - as_timestamp(states.input_select.konnectedstatus.last_changed))\
          \ > 300 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
      - condition: or
        conditions:
        - condition: state
          entity_id: input_select.konnectedstatus
          state: armed_home
        - condition: state
          entity_id: input_select.konnectedstatus
          state: armed_away
  trigger:
    - platform: time_pattern
      minutes: /10
      seconds: 0
  action:
    - service: homeassistant.turn_on
      entity_id: script.konnectedstandby

- id: 72a6ac29-9e75-4f47-a22b-407609b26ee9
  alias: '[Alarm] Konnected Log Motion'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: binary_sensor.entryway
      to: 'on'
    - platform: state
      entity_id: binary_sensor.kitchen
      to: 'on'
    - platform: state
      entity_id: binary_sensor.living_room
      to: 'on'
    - platform: state
      entity_id: binary_sensor.office
      to: 'on'
    - platform: state
      entity_id: binary_sensor.garage
      to: 'on'
    - platform: state
      entity_id: binary_sensor.ring_backyard_motion
      to: 'on'
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_away
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_home
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: pending
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: triggered
  action:
    - service: logbook.log
      data_template:
        name: "Motion detected: "
        message: >-
          {{ trigger.entity_id }}

- id: 0c082214-fab9-4833-9efc-7f220b337811
  alias: '[Alarm] Trigger Alarm'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.Konnected_Alarm
      to: triggered
  action:
    - service: switch.turn_on
      entity_id: switch.siren
    - service: switch.turn_on
      entity_id: switch.backyard_siren
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
          - group.alexa
        message: Your alarm was activated
    - service: notify.all_devices
      data:
        title: Konnected
        message: Your alarm was activated
        data:
          actions:
            - action: open
              icon: "/local/icons/konnected.png"
              title: Open Home Assistant
          tag: konnected-alarm-notification
          ttl: 86400
          priority: high      

- id: 583df5d2-69c7-49e2-93a2-0c49d936b0fb
  alias: '[Alarm] Pending alarm'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: binary_sensor.entryway
      to: 'on'
    - platform: state
      entity_id: binary_sensor.kitchen
      to: 'on'
    - platform: state
      entity_id: binary_sensor.living_room
      to: 'on'
    - platform: state
      entity_id: binary_sensor.office
      to: 'on'
    - platform: state
      entity_id: binary_sensor.garage
      to: 'on'
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_away
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_home
  action:
    - service: alarm_control_panel.alarm_trigger
      entity_id: alarm_control_panel.Konnected_Alarm
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
          - group.alexa
        message: Motion detected, the alarm will activate shortly. Motion detected, the alarm will activate shortly.

- id: d2851e95-9ef6-49bf-973d-9ed51545414c
  alias: '[Climate] Cancel thermostat ETA'
  initial_state: 'true'
  condition:
    - condition: template
      value_template: '{{ states.sensor.retsinagaard_eta != "1970-01-01 00:00:00+00:00"
        }}'
  trigger:
    - platform: state
      entity_id: group.household
      from: not_home
      to: home
    - platform: template
      value_template: "{% if is_state_attr('proximity.home', 'dir_of_travel', 'towards') %}false{% endif %}"
      for: '00:05:00'
  action:
    - service: nest.cancel_eta
      data:
        trip_id: ETA set by HAS
        structure:
          - Retsinagaard
    - service: homeassistant.turn_on
      data_template:
        entity_id: "{%- if states('switch.living_room_away') == 'on' -%}\n  switch.living_room_away\n\
          {%- endif -%}\n"

- id: 763d3d6d-c8f2-473b-86ed-ad6d41ff0083
  alias: '[Climate] Disable thermostat away'
  initial_state: 'true'
  condition:
    - condition: template
      value_template: '{{states(''input_select.konnectedstatus'') == ''disarmed'' and
        states(''group.thermostats'') == ''on''}}

        '
  trigger:
    - platform: time_pattern
      minutes: /5
      seconds: 0
  action:
    - service: homeassistant.turn_off
      data_template:
        entity_id: "{%- if states('switch.living_room_away') == 'on' -%}\n  switch.living_room_away\n\
          {%- endif -%}\n"

- id: e7d7fec6-be05-4aa2-bdd5-e8b2a4c585e7
  alias: '[Climate] Enable thermostat away'
  initial_state: 'true'
  condition:
    - condition: or
      conditions:
        - condition: template
          value_template: '{{states(''input_select.konnectedstatus'') == ''armed_away''
            and states(''switch.living_room_away'') == ''off''}}

            '
  trigger:
    - platform: time_pattern
      minutes: /5
      seconds: 0
  action:
    - service: homeassistant.turn_on
      data_template:
        entity_id: "{%- if states('switch.living_room_away') == 'off' -%}\n  switch.living_room_away\n\
          {%- endif -%}\n"

- id: 82e04eda-e291-4af7-be6f-f6ec33719802
  alias: '[Climate] Set thermostat ETA'
  initial_state: 'true'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.household
        state: not_home
      - condition: state
        entity_id: binary_sensor.retsinagaard_away
        state: 'on'
  trigger:
    - platform: template
      value_template: "{%- if is_state_attr('proximity.home', 'dir_of_travel', 'towards')\
        \ -%}\n  true\n{%- endif -%}\n"
  action:
    - service: nest.set_eta
      data_template:
        eta: >
          {% if is_state_attr('proximity.home', 'nearest', 'Dennis') %}
            {{ ((( states.sensor.dennis_to_home.state | int) * 60) - 3600) | timestamp_custom('%H:%M:%S') }}
          {% elif is_state_attr('proximity.home', 'nearest', 'Dennis, Stephanie') %}
            {{ ((( states.sensor.dennis_to_home.state | int) * 60) - 3600) | timestamp_custom('%H:%M:%S') }}
          {% elif is_state_attr('proximity.home', 'nearest', 'Stephanie') %}
            {{ ((( states.sensor.stephanie_to_home.state | int) * 60) - 3600) | timestamp_custom('%H:%M:%S') }}
          {% endif %}
        eta_window: 00:01
        trip_id: ETA set by HAS
        structure:
          - Retsinagaard

- id: 811e963d-f24e-47bd-b0fb-b519bb0e6dbb
  alias: '[Climate] Away Mode'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: group.household
      from: home
      to: not_home
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
      for: 00:05:00
  action:
    - service: climate.set_preset_mode
      entity_id:
        - climate.living_room
      data: {"preset_mode": "away"}

- id: 039d5bb6-5335-4c0c-9c37-c0d286bcecae
  alias: '[Climate] Home Mode'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: group.household
      from: not_home
      to: home
  action:
    - service: climate.set_preset_mode
      entity_id:
        - climate.living_room
      data: {"preset_mode": "home"}

- id: f22881d0-2a37-46f6-86fa-0feaac19de59
  alias: '[Covers] Open in the morning in Master Bedroom'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: state
      entity_id: group.household
      state: 'home'
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'on'
  trigger:
    - platform: time
      at: "08:30:00"
  action:
    - service: cover.open_cover
      data:
        entity_id: cover.master_bedroom_roller_shutter_level

- id: 2c0fabaa-793e-4d83-a6f6-488b799384e7
  alias: '[Covers] Open in the morning in Lucas Room'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: state
      entity_id: group.household
      state: 'home'
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'on'
  trigger:
    - platform: time
      at: "09:00:00"
  action:
    - service: cover.open_cover
      data:
        entity_id: cover.lucas_room_roller_shutter_level

- id: 9168307a-6555-489d-b686-643216ff76e9
  alias: '[Covers] Open in the morning during the weekends and holidays'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: state
      entity_id: group.household
      state: 'home'
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'off'
  trigger:
    - platform: time
      at: "11:00:00"
  action:
    - service: cover.open_cover
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level

- id: 58a2e68e-7adf-4d08-93d1-a4dd43faeb12
  alias: '[Covers] Close in the evening'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: state
      entity_id: group.household
      state: 'home'
  trigger:
    - platform: sun
      event: sunset
  action:
    - service: cover.set_cover_position
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level
        position: 10

- id: 36999f33-8fcb-423e-972d-425b4efca279
  alias: '[Covers] Close with strong winds'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: state
      entity_id: sun.sun
      state: below_horizon
  trigger:
    - platform: numeric_state
      entity_id: sensor.br_wind_force
      above: 4
  action:
    - service: cover.close_cover
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level

- id: d3a773bf-fc19-4f77-8ad7-00097a2a8bfa
  alias: '[Covers] Open when arriving 1'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: numeric_state
      entity_id: sensor.br_temperature
      below: 25
    - condition: state
      entity_id: sun.sun
      state: above_horizon # at daytime
    - condition: template
      value_template: "{%- if states.automation.covers_close_when_leaving.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.covers_close_when_leaving.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
  trigger:
    - platform: state
      entity_id: group.household
      from: 'not_home'
      to: 'home'
  action:
    - service: cover.open_cover
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level

- id: 9c7f65fd-fc67-47e1-a81d-e02afcacdc3e
  alias: '[Covers] Open when arriving 2'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: numeric_state
      entity_id: sensor.br_temperature
      below: 25
    - condition: state
      entity_id: sun.sun
      state: below_horizon
    - condition: template
      value_template: "{%- if states.automation.covers_close_when_leaving.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.covers_close_when_leaving.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
  trigger:
    - platform: state
      entity_id: group.household
      from: 'not_home'
      to: 'home'
  action:
    - service: cover.set_cover_position
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level
        position: 10

- id: 153b5394-3dde-4ebd-8e3f-4d2bb43e8529
  alias: '[Covers] Close when leaving'
  initial_state: 'true'
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    - condition: template
      value_template: "{%- if states.automation.covers_open_when_arriving_1.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.covers_open_when_arriving_1.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
    - condition: template
      value_template: "{%- if states.automation.covers_open_when_arriving_2.attributes.last_triggered\
        \ -%}\n  {{ (as_timestamp(now()) - as_timestamp(states.automation.covers_open_when_arriving_2.attributes.last_triggered))\
        \ > 240 }}\n{%- else -%}\n  true\n{%- endif -%}\n"
  trigger:
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
    - platform: numeric_state
      entity_id: sensor.br_temperature
      above: 25
  action:
    - service: cover.close_cover
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level

- id: c209375b-d473-4d56-8f02-41c3146eae35
  alias: '[Covers] Open when smoke or CO detected'
  initial_state: 'true'
  condition:
  trigger:
    - platform: state
      entity_id: sensor.entryway_nest_protect_smoke_status
      from: 'ok'
    - platform: state
      entity_id: sensor.entryway_nest_protect_co_status
      from: 'ok'
    - platform: state
      entity_id: sensor.hallway_nest_protect_smoke_status
      from: 'ok'
    - platform: state
      entity_id: sensor.hallway_nest_protect_co_status
      from: 'ok'
    - platform: state
      entity_id: sensor.attic_nest_protect_smoke_status
      from: 'ok'
    - platform: state
      entity_id: sensor.attic_nest_protect_co_status
      from: 'ok'
  action:
    - service: cover.open_cover
      data:
        entity_id:
          - cover.master_bedroom_roller_shutter_level
          - cover.lucas_room_roller_shutter_level

- id: 2ae00756-b4a9-4068-acc8-c574a8a60fd4
  alias: '[Ring]  Motion in backyard'
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_backyard_motion
      to: 'on'
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_away
      - condition: state
        entity_id: alarm_control_panel.Konnected_Alarm
        state: armed_home
  action:
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target:
          - group.alexa
        message: "Motion in the backyard"
    - service: notify.all_devices
      data:
        title: Ring
        message: There is motion at your backyard
        data:
          actions:
            - action: open
              icon: "/local/icons/konnected.png"
              title: Open Home Assistant
          tag: ring_alert
          ttl: 86400
          priority: high      

- id: 6afbd950-7db2-44df-8eb4-d6c46d57f7af
  alias: '[Ring] Low Battery Notification'
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.ring_front_door_battery
        - sensor.ring_backyard_battery
      below: 15
    - platform: numeric_state
      entity_id:
        - sensor.ring_front_door_battery
        - sensor.ring_backyard_battery
      below: 10
  action:
    - service: persistent_notification.create
      data_template:
        message: "{{ trigger.entity_id.name }} reported low battery, please charge."
        title: Ring Battery Low
    - service: notify.mobile_app_sm_g960f
      data_template:
        message: "{{ trigger.entity_id.name }} reported low battery, please charge."
        title: Ring Battery Low
